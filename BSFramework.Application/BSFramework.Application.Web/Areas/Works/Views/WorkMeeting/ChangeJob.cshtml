@using BSFramework.Application.Entity.BaseManage
@model BSFramework.Entity.WorkMeeting.MeetingJobEntity
@{ ViewBag.Title = "JobDetail";
    Layout = "~/Views/Shared/_LayoutEmptyScroll.cshtml"; }
<link rel="stylesheet" href="@Url.Content("~/Content/styles/static/css/launch-activity.css")" />
<link rel="stylesheet" href="@Url.Content("~/Content/styles/static/css/extend.css")" />
<link rel="stylesheet" href="@Url.Content("~/Content/styles/static/css/app.css")" />
<link rel="stylesheet" href="@Url.Content("~/Content/styles/static/css/before.css")" />
<script src="@Url.Content("~/Content/scripts/layui/layui.all.js")"></script>
<script src="@Url.Content("~/Content/scripts/validator/Validform.min.js")"></script>
<script src="@Url.Content("~/Content/scripts/plugins/hammer.js")"></script>
<script src="@Url.Content("~/Content/scripts/jquery/jquery.dateFormat.js")"></script>

<style>
    .audio-list {
        float: left;
    }

        .audio-list li {
            list-style: none;
        }

    .image-list {
        height: 200px;
    }

        .image-list li {
            list-style: none;
            float: left;
            margin: 10px;
        }

            .image-list li img {
                cursor: pointer;
            }

    .Validform_checktip {
        text-align: center;
        font-size: 12px;
        line-height: 20px;
    }

    .Validform_wrong {
        color: red;
    }

    .play-audio {
        margin: 5px 10px;
    }
</style>
<script>
    var imagedata = {};
    var jobId;
    jQuery(function () {
        //$('#play-audio-container').delegate('.play-audio', 'click', function () {
        //    var url = $(this).data('url');
        //    var html = '<audio id="audio" src="' + url + '" controls autoplay style="width:483px;display:block;"></audio>';
        //    $('#audio-warp').append(html);
        //    $('#audio')[0].addEventListener('canplaythrough', function () {
        //        this.play();
        //    });
        //    layer.open({
        //        type: 1,
        //        area: ['460px', '50px'],
        //        content: $('#audio-warp '),
        //        title: false,
        //        end: function () {
        //            $('#audio-warp').empty();
        //            $('#audio-warp').hide();
        //        }
        //    })
        //});

        //$('.images-container').delegate('li', 'click', function () {
        //    imagedata.start = jQuery(this).index();
        //    layer.photos({
        //        photos: imagedata,
        //        anim: 5
        //    })
        //});
        //初始化页面数据
        if(@ViewBag.LoadData == true)
            initPageData();

        $('.sf').Validform({
            tiptype: 3,
            tipSweep: true
        });


        jQuery('#jobuser-modal tr span.my-ck').click(function () {
            if (jQuery(this).hasClass('on')) {
                jQuery(this).removeClass('on');
            } else {
                if (jQuery(this).hasClass('ischecker')) {
                    jQuery('.ischecker').removeClass('on');
                }
                jQuery(this).parent().parent().find('.my-ck').removeClass('on');
                jQuery(this).addClass('on');
            }

            var ids = '', names = '', jobusers = [];
            jQuery('#jobuser-modal span.on').each(function () {
                var userid = jQuery(this).parent().parent().data('userid');
                var username = jQuery(this).parent().parent().find('td:first').text();
                var role = jQuery(this).data('role');
                names += username + ',';
                ids += userid + ',';
                jobusers.push({ UserId: userid, UserName: username, JobType: role });
            });

            var doPersons = '';
            var checker = '';
            for (var i = 0; i < jobusers.length; i++) {

                if (jobusers[i].JobType == 'ischecker') {
                    checker = jobusers[i].UserName;
                }
                else {
                    doPersons += jobusers[i].UserName+',';
                }
            }
            jQuery('#checker').val(checker)
            jQuery('#teammaters').val(doPersons.replace(/,$/, ''));
            jQuery('#JobUsers').val(names.replace(/,$/, ''));
            jQuery('#jobuser').val((checker + ',' + doPersons).replace(/,$/, ''));
            jQuery('#UserId').val(ids.replace(/,$/, ''));

            jQuery('#Persons').val(JSON.stringify(jobusers));
        });


        $('.my-close').click(function () {
            //if(jQuery('selecting').attr('id') == 'checker'){
            //    if (!jQuery('#jobuser-modal span.on').hasClass('ischecker'))
            //        layer.alert('请选择工作负责人', { icon: 0 });
            //    else {
            //        layer.closeAll();
            //        return false;
            //    }
            //}
            layer.closeAll();
        });

        jQuery('#job').attr('readonly', 'readonly');
        jQuery('#dangerous').attr('readonly', 'readonly');
        jQuery('#measure').attr('readonly', 'readonly');
        jQuery('#remark').attr('readonly', 'readonly');
    });



    //初始化页面数据，调用父页面函数并赋值
    function initPageData() {
        //赋值
        var obj = parent.fn$getjob();
        console.log(obj)
        jobId = obj.jobid;
        jQuery("#jobId").val(obj.jobid);
        jQuery('#job').val(obj.job);
        //jQuery('#checker').val(obj.checker);
        //jQuery('#teammaters').val(obj.teammaters);
        jQuery('#jobuser').val(obj.checker + ',' +obj.teammaters);
        jQuery('#StartTime').val(jQuery.format.date(new Date(obj.StartTime), 'yyyy/MM/dd HH:mm'));
        jQuery('#EndTime').val(jQuery.format.date(new Date(obj.EndTime), 'yyyy/MM/dd HH:mm'));
        jQuery('#dangerous').val(obj.dangerous);
        jQuery('#measure').val(obj.measure);
        jQuery('#Persons').val(obj.persons);
        jQuery('#meetingId').val(obj.meetingId);
        jQuery('#remark').val(obj.remark);
        jQuery('#UserId').val(obj.userId);
        jQuery('#description').val(obj.Description);
        jQuery('#TaskType').find("option[value=" + obj.TaskType + "]").attr("selected", true);
        jQuery('#RiskLevel').find("option[value=" + obj.RiskLevel + "]").attr("selected", true);
        if (obj.jobtype == "班后会") {
            jQuery('#DescriptionDiv').css('display', 'block');

            jQuery.getJSON('@Url.Action("GetJobFiles")/' + obj.meetingjobid, null, function (data) {
                if (data.success) {
                    var ary_user = [], htmlaudios = '';
                    jQuery.each(data.data.audios, function (i, o) {
                        ary_user.push(o.CreateUserName);
                    });
                    ary_user = jQuery.unique(ary_user);

                    jQuery.each(ary_user, function (i, o) {
                        htmlaudios += '<li><label>' + o + '</label>';
                        jQuery.each(data.data.audios, function (j, p) {
                            if (o == p.CreateUserName)
                                htmlaudios += '<span class="play-audio" data-url="' + p.FilePath + '" onclick="seeaudio(this)"><img src="@Url.Content("~/Content/styles/static/images/horn-icon.png")" width="24" />' + p.FileName + '</span>'
                        });
                        htmlaudios += '</li>'
                    });
                    jQuery('#play-audio-container').append(htmlaudios);
                    imagedata.data = [];

                    var htmlimages = "", ary_user = [];
                    jQuery.each(data.data.images, function (i, o) {
                        ary_user.push(o.CreateUserName);
                    });
                    ary_user = jQuery.unique(ary_user);

                    var imgindex = 0;
                    jQuery.each(ary_user, function (i, o) {
                        htmlimages += '<div class="image-list"><label>' + o + '</label><ul id="images-container" class="images-container" style="min-height:60px;">';
                        jQuery.each(data.data.images, function (j, p) {
                            if (o == p.CreateUserName) {
                                htmlimages += '<li><img src="' + p.FilePath + '" style="width:160px;height:120px;" onclick="seeimage(' + imgindex + ')" /></li>'
                                imagedata.data.push({ src: p.FilePath });
                                imgindex++;
                            }
                        });
                        htmlimages += '</ul></div>'
                    });
                    jQuery('#imagepart div').append(htmlimages);

                    //jQuery.each(data.data.images, function (i, o) {
                    //    //返回值根据名称排序  初始化 audiosUser 为空
                    //    if (o.CreateUserName != imagesUser) {
                    //        //第一次初始化
                    //        if (!imagesUser) {
                    //            htmlimages += '<div class="clearfix audio">';
                    //            htmlimages += '<div class="pull-left my-form-control w-90-">';
                    //            htmlimages += '<label>' + o.CreateUserName + '</label>';
                    //            htmlimages += '<div class="image-list">';
                    //            htmlimages += '<img   onclick="seeimage(' + i + ')" data-id="' + o.FileId + '" src="' + o.FilePath + '"  alt="" style="width:160px;height:120px;"/>';
                    //        }
                    //        //循环结尾
                    //        if (i == data.data.images.length) {
                    //            htmlimages += '</div></div></div>'
                    //        } else
                    //            if (i > 1) {
                    //                //循环进行中
                    //                htmlimages += '</div></div></div>'
                    //                htmlimages += '<div class="clearfix audio" >';
                    //                htmlimages += '<div class="pull-left my-form-control w-90-">';
                    //                htmlimages += '<label>' + o.CreateUserName + '</label>';
                    //                htmlimages += '<div class="image-list">';
                    //            }

                    //        imagesUser = o.CreateUserName;

                    //    } else {
                    //        htmlimages += '<img   onclick="seeimage(' + i + ')" data-id="' + o.FileId + '" src="' + o.FilePath + '"  alt="" style="width:160px;height:120px;"/>';
                    //    }
                    //    imagedata.data.push({ src: o.FilePath });

                    //});
                }
            });
        } else {
            jQuery('#audiopart').hide();
            jQuery('#imagepart').hide();
        }
    }
    function seeaudio(obj) {
        var url = $(obj).data('url');
        var html = '<audio id="audio" src="' + url + '" controls autoplay style="width:483px;display:block;"></audio>';
        $('#audio-warp').append(html);
        $('#audio')[0].addEventListener('canplaythrough', function () {
            this.play();
        });
        layer.open({
            type: 1,
            area: ['460px', '50px'],
            content: $('#audio-warp '),
            title: false,
            end: function () {
                $('#audio-warp').empty();
                $('#audio-warp').hide();
            }
        })
    };

    function seeimage (index) {
        imagedata.start = index;
        layer.photos({
            photos: imagedata,
            anim: 5
        })
    }
    //在页面上选中工作组成员
    function checkPerson(userName , tr , personJson){
        for (var i = 0; i < personJson.length; i++) {
            if (userName == personJson[i].UserName && personJson[i].JobType == "ischecker") {
                $(tr).find("td:eq(1) span").addClass("on");
            }
            if (userName == personJson[i].UserName && personJson[i].JobType == "isdoperson") {
                $(tr).find("td:eq(2) span").addClass("on");
            }
        }
    }
    //提交表单
    function fn$ChangeJob() {
        $("form").submit();
    }

    //任务取消
    function fn$CancelJob(){
        var jobId = $("#jobId").val();
        var meetingjobid = jQuery('#Relation_MeetingJobId').val();
        $.post('@Url.Action("CancelJob")', {id : jobId,meetingjobid:meetingjobid} , function(){
            jQuery(parent).get(0).fn$callback();
        });
    }

    //取消任务弹出框
    function fn$ConfirmCancelJob() {
        layer.confirm("确定取消该任务吗？",{title:"提示"},function(){
            fn$CancelJob();
        })
    }

    var isEdit = false;
    function fn$edit(){
        isEdit = true;
        dangerousList = JSON.parse(jQuery('#dangerousList').val());
        jQuery('#job').removeAttr('readonly');
        jQuery('#dangerous').removeAttr('readonly');
        jQuery('#measure').removeAttr('readonly');
        jQuery('#description').removeAttr('readonly');
        jQuery('#TaskType').removeAttr('disabled');
        jQuery('#RiskLevel').removeAttr('disabled');

        jQuery('#buttons li:eq(0)').show();
        jQuery('#buttons li:eq(1)').show();
        jQuery('#buttons li:eq(2)').hide();


        jQuery('#checker,#teammaters,#jobuser').click(function (e) {
            jQuery('.selecting').removeClass('selecting');
            jQuery(this).addClass('selecting');
            var size = jQuery('#jobuser-modal tr').size();
            var h = 55 * (size) + 120;
            var winH = $(window).height();
            if (h > winH - 100) {
                h = winH - 100
            }

            //打开选择人弹框
            layer.open({
                area: ['500px', h + 'px'],
                title: '选择作业人',
                type: 1,
                content: $('#jobuser-modal'),
                //cancel: function () {
                //    jQuery('#jobuser-modal span.on').each(function () {
                //        jQuery(this).removeClass('on');
                //    })
                //    jQuery('#UserId').val("");
                //    jQuery('#JobUsers').val("");
                //    jQuery('#Persons').val("");
                //    $('#jobuser-modal').hide();
                //},
                end: function () {
                    $('#jobuser-modal').hide();
                }
            });

            var personJson = jQuery.parseJSON($("#Persons").val());
            var eleId = $(e.target).attr("id");
            //隐藏负责人列
            //if (eleId == 'teammaters') {
            //    $("#tblPersons").find("tr").each(function () {
            //        var userName = $(this).find("td:eq(0)").text();
            //        $(this).find("td:eq(1)").hide();
            //        $(this).find("td:eq(2)").show();
            //        //默认选中人员
            //        checkPerson(userName,this,personJson);
            //    })
            //}
            //else {
            //    $("#tblPersons").find("tr").each(function () {
            //        var userName = $(this).find("td:eq(0)").text();

            //        $(this).find("td:eq(2)").hide();
            //        $(this).find("td:eq(1)").show();
            //        //默认选中人员
            //        checkPerson(userName,this,personJson);
            //    })
            //}

            jQuery('#jobuser-modal').parent().css('overflow-y', 'hidden');
            jQuery('#jobuser-modal div:first-child').css('overflow', 'auto');
            jQuery('#jobuser-modal').height(jQuery('#jobuser-modal').parent().height());
            jQuery('#jobuser-modal div:first-child').height(jQuery('#jobuser-modal').parent().height() - 60);

        });


        //日期选择
        layui.use('laydate', function () {
            var laydate = layui.laydate;
            laydate.render({
                elem: '#StartTime',
                type: 'datetime',
                format: 'yyyy/MM/dd HH:mm'
            });
        });
        layui.use('laydate', function () {
            var laydate = layui.laydate;
            laydate.render({
                elem: '#EndTime',
                type: 'datetime',
                format: 'yyyy/MM/dd HH:mm'
            });
        });
    }

    @ViewBag.callback
</script>

<div id="audio-warp" style="height:50px;width:460px;display: none;overflow:hidden;">
</div>
<div class="main-content" style="margin-left:20px;">
    <div class="container-fluid">
        @using (Html.BeginForm("ChangeJob", "WorkMeeting", FormMethod.Post, new { @class = "sf" }))
        {
@Html.HiddenFor(x => x.JobId)
                @Html.HiddenFor(x => x.Relation.MeetingJobId)
                                <input type="hidden" id="jobId" name="JobId" value="" />
                                                <input type="hidden" id="meetingId" name="MeetingId" value="" />
                                                                <input type="hidden" id="dangerousList" name="dangerousList" value="@ViewBag.dangerousList" />
                                                                                <div class="pull-right pd-10" style="position:absolute; right:50px; top:20px;">
                                                                                    <ul class="nav nav-last" id="buttons">
                                                                                        <li class="clearfix  pd-10" style="cursor:pointer;display:none;">
                                                                                            <div class="pull-left">
                                                                                                <img src="~/Content/images/metting_canceltask.png" />
                                                                                                <a href="javascript:void(0);" onclick="fn$ConfirmCancelJob()">取消任务</a>
                                                                                            </div>
                                                                                        </li>
                                                                                        <li class="clearfix pd-10" style="cursor:pointer;display:none;">
                                                                                            <div class="pull-left">
                                                                                                <img src="~/Content/images/metting_changetask.png" />
                                                                                                <a href="javascript:void(0);" onclick="fn$ChangeJob()">保存记录</a>
                                                                                            </div>
                                                                                        </li>
                                                                                        <li class="clearfix pd-10" style="cursor:pointer;" onclick="fn$edit()">
                                                                                            <div class="pull-left">
                                                                                                <img src="~/Content/images/metting_changetask.png" />
                                                                                                <a href="javascript:void(0);">编辑</a>
                                                                                            </div>
                                                                                        </li>
                                                                                    </ul>
                                                                                </div>

                                                                                                <div class="bg-fff pd-10">
                                                                                                    <div class="clearfix">
                                                                                                        <div class="pull-left my-form-control w-90-">
                                                                                                            <label>工作任务</label>
                                                                                                            <div>
                                                                                                                <input name="Job" id="job" type="text" class="block" datatype="*1-200" nullmsg="不能为空" />
                                                                                                            </div>
                                                                                                        </div>
                                                                                                    </div>

                                                                                                    <div class="clearfix">
                                                                                                        <div class="pull-left my-form-control" style="width:45%;">
                                                                                                            <label>作业人</label>
                                                                                                            <div>
                                                                                                                <input type="hidden" name="UserId" id="UserId" />
                                                                                                                <input type="hidden" name="Persons" id="Persons" />
                                                                                                                <input type="hidden" name="JobUsers" id="JobUsers" />
                                                                                                                <input name="jobuser" datatype="*" nullmsg="不能为空" id="jobuser" type="text" readonly="readonly" />
                                                                                                            </div>
                                                                                                        </div>
                                                                                                        @*<div class="pull-left my-form-control w-30-">
                                                                                                                <label>工作负责人</label>
                                                                                                                <div>
                                                                                                                    <input type="hidden" name="UserId" id="UserId" />
                                                                                                                    <input type="hidden" name="Persons" id="Persons" />
                                                                                                                    <input type="hidden" name="JobUsers" id="JobUsers" />
                                                                                                                    <input name="checker" datatype="*" nullmsg="不能为空" id="checker" type="text" readonly="readonly" />
                                                                                                                </div>
                                                                                                            </div>
                                                                                                            <div class="pull-left my-form-control w-30-">
                                                                                                                <label>工作组成员</label>
                                                                                                                <div>
                                                                                                                    <input name="teammaters" id="teammaters" type="text" readonly="readonly" />
                                                                                                                </div>
                                                                                                            </div>*@
                                                                                                        <div class="pull-left my-form-control" style="width:45%;">
                                                                                                            <label>计划时间</label>
                                                                                                            <div>
                                                                                                                <input name="StartTime" id="StartTime" type="text" datatype="*" nullmsg="不能为空" readonly="readonly" placeholder="请选择" style="width:180px;text-align:center;" /> -
                                                                                                                <input name="EndTime" id="EndTime" type="text" datatype="*" nullmsg="不能为空" readonly="readonly" placeholder="请选择" style="width:180px;text-align:center;" />
                                                                                                            </div>
                                                                                                        </div>
                                                                                                    </div>
                                                                                                    <div class="clearfix">
                                                                                                        <div class="pull-left my-form-control" style="width:45%;">
                                                                                                            <label>任务类别</label>
                                                                                                            <div>
                                                                                                                <select name="TaskType" id="TaskType" disabled>
                                                                                                                    <option value="日常工作">日常工作</option>
                                                                                                                    <option value="管理任务">管理任务</option>
                                                                                                                    <option value="巡回检查">巡回检查</option>
                                                                                                                    <option value="定期工作">定期工作</option>
                                                                                                                    <option value="消缺任务">消缺任务</option>
                                                                                                                    <option value="其他工作">其他工作</option>
                                                                                                                </select>
                                                                                                            </div>
                                                                                                        </div>
                                                                                                        <div class="pull-left my-form-control" style="width:45%;">
                                                                                                            <label>风险等级</label>
                                                                                                            <div>
                                                                                                                <select name="RiskLevel" id="RiskLevel" disabled>
                                                                                                                    <option value="重大风险">重大风险</option>
                                                                                                                    <option value="较大风险">较大风险</option>
                                                                                                                    <option value="一般风险">一般风险</option>
                                                                                                                    <option value="低风险" selected="selected">低风险</option>
                                                                                                                </select>
                                                                                                            </div>
                                                                                                        </div>
                                                                                                    </div>
                                                                                                    <div class="clearfix">
                                                                                                        <div class="pull-left my-form-control w-90-">
                                                                                                            <label>危险因素</label>
                                                                                                            <div>
                                                                                                                <textarea name="Dangerous" id="dangerous" class="selectDanger"></textarea>
                                                                                                            </div>
                                                                                                        </div>
                                                                                                    </div>
                                                                                                    <div class="clearfix">
                                                                                                        <div class="pull-left my-form-control w-90-">
                                                                                                            <label>防范措施</label>
                                                                                                            <div>
                                                                                                                <textarea name="Measure" id="measure" class="selectMeasure"></textarea>
                                                                                                            </div>
                                                                                                        </div>
                                                                                                    </div>
                                                                                                    <div class="clearfix" id="DescriptionDiv" style="display:none">
                                                                                                        <div class="pull-left my-form-control w-90-">
                                                                                                            <label>任务说明</label>
                                                                                                            <div>
                                                                                                                <textarea name="Description" id="description" readonly="readonly"></textarea>

                                                                                                            </div>
                                                                                                        </div>
                                                                                                    </div>
                                                                                                    <div class="clearfix">
                                                                                                        <div class="pull-left my-form-control w-90-">
                                                                                                            <label>备注</label>
                                                                                                            <div>
                                                                                                                <textarea name="Remark" id="remark"></textarea>
                                                                                                            </div>
                                                                                                        </div>
                                                                                                    </div>
                                                                                                    <div class="clearfix audio" id="audiopart">
                                                                                                        <div class="pull-left my-form-control w-90-">
                                                                                                            <label>音频</label>
                                                                                                            <div class="audio-list">
                                                                                                                <ul id="play-audio-container">
                                                                                                                    @*<li>
                                                                                                                            <div class="play-audio" data-url="SJ002F001.mp3"><img src="@Url.Content("~/Content/styles/static/images/horn-icon.png")" alt="" width="24">SJ002F001.mp3</div>
                                                                                                                            <button></button>
                                                                                                                        </li>*@
                                                                                                                </ul>
                                                                                                            </div>
                                                                                                        </div>
                                                                                                    </div>
                                                                                                    <div class="clearfix audio" id="imagepart">
                                                                                                        <div class="pull-left my-form-control w-90-">
                                                                                                            <label>照片</label>
                                                                                                        </div>
                                                                                                    </div>
                                                                                                </div>}
    </div>
</div>

<!--选择作业人员弹出层-->
<div class="my-modal" id="jobuser-modal" style="display:none;">
    @{ var users = (IList<UserEntity>)ViewData["users"]; }
    <div style="overflow-y:scroll;height:100%;">
        <table class="table" style="text-align:center;" id="tblPersons">
            <tr>
                <td style="width:40%;">班组成员</td>
                <td style="width:30%;">工作负责人</td>
                <td style="width:30%;">工作班成员</td>
            </tr>
            @for (int i = 0; i < users.Count; i++)
            {
<tr data-userid="@Html.Raw(users[i].UserId)">
    <td>@Html.Raw(users[i].RealName)</td>
    <td><span class="my-ck ischecker" data-role="ischecker"></span></td>
    <td><span class="my-ck isdoperson" data-role="isdoperson"></span></td>
</tr>
       }
        </table>
    </div>
    <div class="text-center mg-t-10">
        <button class="btn bg-3669e1 my-close c-fff" style="width:200px;">确定</button>
    </div>
</div>

<!--选择危险因素-->
<div id="list-dangerous" class="sign modal" style="position:relative;padding:0px;height:100%;">
    <div style="height:100%;">
        <ul class="nav measure_nav ul-container" style="overflow-y:auto;padding:0px 30px;min-height:0px;max-height:initial;"></ul>
        <div style="padding:0px 30px; height:200px;">
            <button class="add_btn" style="width:100%;background-color:#3668e1;line-height:50px;border:none;"><img src="@Url.Content("~/Content/styles/static/images/measure_add.png")"></button>
            <input type="text" placeholder="请输入" maxlength="100" style="width:100%; height:50px;">
        </div>
    </div>
</div>
<script>
    var dangerousList;
    function openDangerous() {
        if(dangerousList == null)
            dangerousList = [];

        jQuery('#list-dangerous li.select').removeClass('select');

        jQuery.each(dangerousList, function (i, o) {
            jQuery('#list-dangerous li[data-id="' + o.DangerousId + '"]').addClass('select');
        });

        jQuery('#list-dangerous').show();

        layer.open({
            title: '危险因素',
            type: 1,
            area: ['400px', jQuery(window).height() - 60 + 'px'],
            content: jQuery('#list-dangerous'),
            scrollbar: true,
            btn: ['确定', '取消'],
            yes: function (index) {
                ensureDangerous();
                jQuery('#list-dangerous').hide();
                layer.close(index);
            },
            end: function () {
                jQuery('#list-dangerous').hide();
            }
        });
    }

    jQuery(function () {
        jQuery('#list-dangerous div ul').height(jQuery(window).height() - 260);

        //点击危险因素
        jQuery('.selectDanger').click(function () {
            if(!isEdit) return;
            jQuery(this).blur();
            //openDangerous();

            top.layer.open({
                id:'DangerReview',
                type: 2,
                title: '风险辨识评估',
                shade: 0.6,
                area: ['1280px', '720px'],
                content: '@Url.Action("DangerReview")',
                btn: ['确定'],
                yes: function (idx, layero) {
                    var iframeWin = top.window[layero.find('iframe')[0]['name']];
                    var dangerList = iframeWin.fn$ok();
                    dangerousList = dangerList;
                    ensureDangerous();
                    top.layer.close(idx);
                }
            });

        });

        //删除按钮阻止事件冒泡
        jQuery('#list-dangerous').on('mousedown', '.delete_btn', function (e) {
            e.stopPropagation();
        });

        //删除危险因素
        jQuery('#list-dangerous').on('click', '.delete_btn', function () {
            var el = this;
            jQuery.post('@Url.Action("DeleteDangerous")', { id: jQuery(this).parent().data('id') }, function (data) {
                if (data.success) {
                    jQuery(el).parent().remove();
                } else {
                    layer.msg(data.message);
                }
            }, 'json');
        });

        //点击隐藏删除
        jQuery(document).mousedown(function () {
            jQuery('#list-dangerous li.remove').toggleClass('remove');
            jQuery('#list-measures li.remove').toggleClass('remove');
        });

        //新增危险因素
        jQuery('#list-dangerous').on('click', '.add_btn', function () {
            var input = jQuery(this).next();
            var text = input.val();
            if (!text) return;

            jQuery.post('@Url.Action("PostDangerous")', { Content: text }, function (data) {
                if (data.success) {
                    jQuery('#list-dangerous ul').prepend('<li data-id="' + data.data.ID + '"><span>' + data.data.Content + '</span><button class="delete_btn">删除</button></li>');
                    input.val('');

                    jQuery('#list-dangerous ul li').first().each(function () {
                        var el = this;
                        var hammer = new Hammer(this);
                        hammer.on('press', function (e) {
                            jQuery(el).addClass('remove');
                        });
                        hammer.on('tap', function (e) {
                            if (jQuery(el).hasClass('select'))
                                removeDangerous(jQuery(el).data('id'));
                            else
                                fn$loadMeasures({ DangerousId: jQuery(el).data('id'), Content: jQuery(el).find('span').text().trim() });
                            jQuery(el).toggleClass('select');
                        });
                    });
                } else {
                    layer.msg(data.message, { icon: 2 });
                }
            }, 'json');
        });

        //载入危险因素
        jQuery.getJSON('@Url.Action("GetDangerous")', {}, function (data) {
            if (data) {
                jQuery.each(data, function (i, o) {
                    jQuery('#list-dangerous ul').append('<li data-id="' + o.ID + '"><span>' + o.Content + '</span><button class="delete_btn">删除</button></li>')
                });
                jQuery('#list-dangerous ul li').each(function () {
                    var el = this;
                    var hammer = new Hammer(this);
                    hammer.on('press', function (e) {
                        jQuery(el).addClass('remove');
                    });
                    hammer.on('tap', function (e) {
                        if (jQuery(el).hasClass('select')) {
                            removeDangerous(jQuery(el).data('id'));
                            jQuery(el).removeClass('select');
                        } else {
                            fn$loadMeasures({ DangerousId: jQuery(el).data('id'), Content: jQuery(el).find('span').text().trim() });
                            jQuery(el).addClass('select');
                        }
                    });
                });
            }
        });
    });

    function removeDangerous(dangerid) {
        jQuery('#list-dangerous li.select[data-id="' + dangerid + '"]').removeClass('select');
        dangerousList = jQuery.grep(dangerousList, function (o) { return o.DangerousId != dangerid; });
    }

    function ensureDangerous() {
        var dangerous = '', measure = '';
        jQuery.each(dangerousList, function (i, o) {
            dangerous += o.Content + '。';
            jQuery.each(o.MeasureList, function (j, p) {
                measure += p.Content + '。';
            });
        });
        jQuery('.selectDanger').val(dangerous);
        jQuery('.selectMeasure').val(measure);
        jQuery('#dangerousList').val(JSON.stringify(dangerousList));
    }
</script>

<!--选择防范措施弹出窗-->
<div id="list-measures" class="sign modal" style="position:relative;padding:0px;height:100%;">
    <div style="height:100%;">
        <ul class="nav measure_nav ul-container" style="overflow-y:auto;padding:0px 30px;min-height:0px;max-height:initial;"></ul>
        <div style="padding:0px 30px; height:200px;">
            <button class="add_btn" style="width:100%;background-color:#3668e1;line-height:50px;border:none;"><img src="@Url.Content("~/Content/styles/static/images/measure_add.png")"></button>
            <input type="text" placeholder="请输入" maxlength="100" style="width:100%; height:50px;">
        </div>
    </div>
</div>
<script>
    jQuery(function () {
        //点击防范措施
        jQuery('.selectMeasure').click(function () {
            if(!isEdit) return;
            jQuery(this).blur();
            //openDangerous();

            top.layer.open({
                id:'DangerReview',
                type: 2,
                title: '风险辨识评估',
                shade: 0.6,
                area: ['1280px', '720px'],
                content: '@Url.Action("DangerReview")',
                btn: ['确定'],
                yes: function (idx, layero) {
                    var iframeWin = top.window[layero.find('iframe')[0]['name']];
                    var dangerList = iframeWin.fn$ok();
                    dangerousList = dangerList;
                    ensureDangerous();
                    top.layer.close(idx);
                }
            });

        });

        //删除按钮阻止事件冒泡
        jQuery('#list-measures').on('mousedown', '.delete_btn', function (e) {
            e.stopPropagation();
        });

        //删除防范措施
        jQuery('#list-measures').on('click', '.delete_btn', function () {
            var el = this;
            jQuery.post('@Url.Action("DeleteMeasure")', { id: jQuery(this).parent().data('id') }, function (data) {
                if (data.success) {
                    jQuery(el).parent().remove();
                } else {
                    layer.msg(data.message);
                }
            }, 'json');
        });

        //新增防范措施
        jQuery('#list-measures').on('click', '.add_btn', function () {
            var dangerid = jQuery('#list-measures ul').data('id');
            var input = jQuery(this).next();
            var text = input.val();
            if (!text) return;

            jQuery.post('@Url.Action("PostMesuare")', { Content: text, RiskFactorId: dangerid }, function (data) {
                if (data.success) {
                    jQuery('#list-measures ul').prepend('<li data-id="' + data.data.ID + '"><span>' + data.data.Content + '</span><button class="delete_btn">删除</button></li>');
                    input.val('');
                    jQuery('#list-measures ul li').first().each(function () {
                        var el = this;
                        var hammer = new Hammer(this);
                        hammer.on('press', function (e) {
                            jQuery(el).addClass('remove');
                        });
                        hammer.on('tap', function (e) {
                            jQuery(el).toggleClass('select');
                        });
                    });
                } else {
                    layer.msg(data.message, { icon: 2 });
                }
            }, 'json');
        });
    });

    //防范措施确定
    function ensureMeasure(id, ary) {
        if (ary.length == 0) {
            jQuery('#list-dangerous li[data-id="' + id + '"]').removeClass('select');
            removeDangerous(id);
        }
        else {
            var dangerous = jQuery.grep(dangerousList, function (o, i) {
                return o.DangerousId == id;
            })[0];
            dangerous.MeasureList = ary;
        }
    }

    //加载防范措施
    function fn$loadMeasures(dangerous) {
        dangerousList.push(dangerous);
        jQuery('#list-measures ul').empty();
        jQuery('#list-measures div ul').height(jQuery(window).height() - 260);
        jQuery('#list-measures div ul').data('id', dangerous.DangerousId);
        jQuery.getJSON('@Url.Action("GetMeasures")', { dangerid: dangerous.DangerousId }, function (data) {
            if (data) {
                jQuery.each(data, function (i, o) {
                    jQuery('#list-measures ul').append('<li data-id="' + o.ID + '"><span>' + o.Content + '</span><button class="delete_btn">删除</button></li>')
                });
            }
            jQuery('#list-measures ul li').each(function () {
                var el = this;
                var hammer = new Hammer(this);
                hammer.on('press', function (e) {
                    jQuery(el).addClass('remove');
                });
                hammer.on('tap', function (e) {
                    jQuery(el).toggleClass('select');
                });
            });
        });

        layer.open({
            title: '防范措施',
            type: 1,
            area: ['500px', jQuery(window).height() - 60 + 'px'],
            content: jQuery('#list-measures'),
            scrollbar: true,
            btn: ['确定', '取消'],
            yes: function (index, layero) {
                var ary = [];
                jQuery('#list-measures li.select').each(function () {
                    ary.push({ DangerousId: jQuery(this).data('id'), Content: jQuery(this).find('span').text().trim() });
                });
                ensureMeasure(jQuery('#list-measures ul').data('id'), ary);
                jQuery('#list-measures').hide();
                layer.close(index);
            },
            btn2: function () {
                removeDangerous(jQuery('#list-measures ul').data('id'));
                jQuery('#list-measures').hide();
            },
            cancel: function () {
                removeDangerous(jQuery('#list-measures ul').data('id'));
                jQuery('#list-measures').hide();
            }
        });

        jQuery('#list-measures').show();
    }
</script>

@*取消任务弹出框*@
<div class="confirCancelJob" style="display:none;">
    <div style="text-align:center; margin-top:10px;">确定取消该工作吗？</div>

</div>



