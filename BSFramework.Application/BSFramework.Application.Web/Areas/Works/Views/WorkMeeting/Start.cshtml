@using BSFramework.Entity.WorkMeeting
@using BSFramework.Application.Entity.BaseManage

@model BSFramework.Entity.WorkMeeting.WorkmeetingEntity
@{ ViewBag.Title = "Start";
    Layout = "~/Views/Shared/_Layout.cshtml"; }
<link rel="stylesheet" href="@Url.Content("~/Content/styles/static/css/before.css")" />
<link rel="stylesheet" href="@Url.Content("~/Content/scripts/plugins/jquery-autocompleter/css/main.css")" />
<style>
    .handler a {
        display: block;
        color: #3669e1;
    }

    .handler li.active a {
        color: #fff;
    }

    .Validform_checktip {
        text-align: center;
        font-size: 12px;
        line-height: 20px;
    }

    .Validform_wrong {
        color: red;
    }

    .c-orange:hover {
        color: orange;
    }

    .sf {
        height: 100%;
    }

    .my-modal {
        display: none;
    }

    .my-tab li {
        height: 40px;
        line-height: 38px;
        font-size: 22px;
    }

    tbody td:nth-child(2) {
        position: relative;
    }

    .layui-layer-content {
        overflow-y: hidden !important;
    }

    .layui-layer-title {
        font-weight: bold;
    }

    .sign.modal .nav li {
        width: 100%;
        line-height: initial;
    }

        .sign.modal .nav li span {
            line-height: 30px;
            padding: 10px 0px;
        }

        .sign.modal .nav li button {
            height: 50px;
            border: none;
        }

    .my-checkbox {
        margin-top: -2px;
        margin-bottom: -2px;
    }

    .datetime {
        width: 120px;
        height: 100%;
        border: none;
    }

    .textbox {
        border: none;
        height: 100%;
        line-height: 16px;
        overflow-y: hidden;
        resize: none;
        outline: none;
    }

    .maxwidth {
        width: 100%;
    }

    .table {
        margin-bottom: 0px;
    }

        .table thead tr th, .table tbody tr td * {
            text-align: center;
        }

        .table > tbody > tr > td {
            padding: 8px 4px;
            vertical-align: middle;
        }

            .table > tbody > tr > td > div {
                width: 100%;
                height: 40px;
                border: 1px solid #e3ebfd;
                padding: 3px;
            }


    .col0 {
        width: 280px;
        padding-left: 8px !important;
    }

    .col1 {
        width: 140px;
    }

    .col2 {
        width: 200px;
    }

    .col3 {
        width: 260px;
    }

    .col4 {
        width: 360px;
    }

    .col5 {
        width: 100px;
    }

    .col6 {
        width: 80px;
    }

    .col7 {
        width: 80px;
    }

    .prettytext {
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
    }
</style>
<script src="@Url.Content("~/Content/scripts/validator/Validform.min.js")"></script>
<script src="@Url.Content("~/Content/scripts/base.js")"></script>
<script src="@Url.Content("~/Content/scripts/layui/layui.all.js")"></script>
<script src="@Url.Content("~/Content/scripts/plugins/jquery-autocompleter/js/jquery.autocompleter.js")"></script>
<script src="@Url.Content("~/Content/scripts/jquery/jquery.dateFormat.js")"></script>
<script src="@Url.Content("~/Content/scripts/plugins/hammer.js")"></script>
<script>
    var meeting;
    var validform;
    var isStart = false;
    $(function () {
        $('.main-sidebar').niceScroll({
            autohidemode: false
        });
        $('.table-today tr').hover(function () {
            $(this).addClass('hover');
        }, function () {
            $(this).removeClass('hover');
        });
        $('.table-today tr').click(function () {
            $(this).toggleClass('actives');
        });
        $('.user>.dropdown-menu').css({
            left: $('.user').innerWidth() - $('.user>.dropdown-menu').width() - 65
        });
        $('.list-item').hover(function () {
            $(this).children('div').stop().animate({
                top: 0
            }, 500);
        }, function () {
            $(this).children('div').stop().animate({
                top: '194px'
            }, 500);
        });

        //jQuery('#grid').parent().prev().css('padding-right', (jQuery('#grid').parent().width() - jQuery('#grid').width() + 'px'));

        $('#tab li').click(function () {
            var index = $(this).index();
            $(this).addClass('active').siblings().removeClass('active');
            $('.tab-item ').eq(index).addClass('show').siblings().removeClass('show');
        });

        //初始化时间控件
        fn$InitDate(jQuery('#grid').get(0));

        //加载数据
        jQuery.getJSON('@Url.Action("GetStartMeeting")', function (data) {
            meeting = data;
            formatDate();
            loadJobs();
        });

        //找任务
        jQuery('#grid').on('focus', '.job', function () {
            jQuery(this).autocompleter({
                source: '@Url.Action("FindJob")',
                highlightMatches: false,
                empty: false,
                cache: false,
                limit: 5,
                customLabel: 'JobContent',
                customValue: 'JobContent',
                callback: function (value, index, selected) {
                    this.parents('.grid-row').find('td:first').find('input:eq(2)').val(selected.JobId);
                }
            });
        });

        //任务改了
        jQuery('#grid').on('change', '.job', function () {
            var job = getJob();
            job.Job = jQuery(this).val();
        });

        //是否KYT
        jQuery('#grid').on('click', '.my-checkbox', function () {
            var job = getJob();
            if (jQuery(this).hasClass('actives')) {
                jQuery(this).removeClass('actives');
                job.NeedTrain = false;
            } else {
                jQuery(this).addClass('actives');
                job.NeedTrain = true;
            }
        });

        //选择任务类型
        jQuery('#grid').on('change', 'select[name=TaskType]', function () {
            var job = getJob();
            if (jQuery(this).hasClass('actives')) {
                jQuery(this).removeClass('actives');
                job.TaskType = $(this).val();
            } else {
                jQuery(this).addClass('actives');
                job.TaskType = $(this).val();
            }
        });

        //选择风险等级
        jQuery('#grid').on('change', 'select[name=RiskLevel]', function () {
            var job = getJob();
            if (jQuery(this).hasClass('actives')) {
                jQuery(this).removeClass('actives');
                job.RiskLevel = $(this).val();
            } else {
                jQuery(this).addClass('actives');
                job.RiskLevel = $(this).val();
            }
        });

        validform = jQuery('.sf').Validform({
            tiptype: 3,
            tipSweep: true,
            callback: function () {
                layer.msg('保存中...', { icon: 16, shade: 0.1, time: 0 });
                //if (meeting.ShouldStartTime)
                //    meeting.ShouldStartTime = new Date(parseInt(meeting.ShouldStartTime.replace(/^\/Date\(/, '').replace(/\)\/$/, '')));
                //if (meeting.ShouldEndTime)
                //    meeting.ShouldEndTime = new Date(parseInt(meeting.ShouldEndTime.replace(/^\/Date\(/, '').replace(/\)\/$/, '')));

                url = '@Url.Action("UpdateJobs")';
                if (isStart) url = '@Url.Action("Start")';
                jQuery.ajax({
                    url: url,
                    type: 'POST',
                    data: JSON.stringify(meeting),
                    dataType: 'json',
                    contentType: 'application/json',
                    success: function (data) {
                        layer.closeAll();
                        if (data.success) {
                            if (data.data.MeetingId)
                                window.location = '@Url.Action("Edit")/' + data.data.MeetingId;
                            else {
                                meeting = data.data;
                                formatDate();
                                loadJobs();
                                jQuery('#btn-submit').attr('disabled', false);
                                jQuery('#btn-save').attr('disabled', false);
                                if (data.message) layer.msg(data.message);
                            }
                        } else {
                            layer.msg(data.message);
                        }
                    }
                });
                jQuery('#btn-submit').attr('disabled', true);
                jQuery('#btn-save').attr('disabled', true);
                return false;
            }
        });
        //设置高度
        $(window).resize(function () {
            setH();
        }).trigger('resize');
    });
    //设置。body的高度
    function setH() {
        $('.my-body').height($('.my-body').height() - 10).css('min-height', 'auto');
    }

    function formatDate() {
        if (typeof (meeting.ShouldStartTime) == 'string') {
            if (meeting.ShouldStartTime.indexOf('Date') >= 0)
                meeting.ShouldStartTime = new Date(parseInt(meeting.ShouldStartTime.replace(/^\/Date\(/, '').replace(/\)$/, '')));
            else
                meeting.ShouldStartTime = new Date(meeting.ShouldStartTime.replace('T', ' '));
        }
        if (typeof (meeting.ShouldEndTime) == 'string') {
            if (meeting.ShouldEndTime.indexOf('Date') >= 0)
                meeting.ShouldEndTime = new Date(parseInt(meeting.ShouldEndTime.replace(/^\/Date\(/, '').replace(/\)$/, '')));
            else
                meeting.ShouldEndTime = new Date(meeting.ShouldEndTime.replace('T', ' '));
        }
    }

    //时间选择控件
    function fn$InitDate(el) {
        jQuery(el).find('input.start').each(function () {
            var el = this;
            layui.use('laydate', function () {
                var laydate = layui.laydate;
                laydate.render({
                    elem: el,
                    type: 'datetime',
                    format: 'yyyy/MM/dd HH:mm',
                    done: function (val, date) {
                        var job = getJob();
                        job.StartTime = new Date(date.year, date.month - 1, date.date, date.hours, date.minutes);
                    }
                });
            });
        });
        jQuery(el).find('input.end').each(function () {
            var el = this;
            layui.use('laydate', function () {
                var laydate = layui.laydate;
                laydate.render({
                    elem: el,
                    type: 'datetime',
                    format: 'yyyy/MM/dd HH:mm',
                    done: function (val, date) {
                        var job = getJob();
                        job.EndTime = new Date(date.year, date.month - 1, date.date, date.hours, date.minutes);
                    }
                });
            });
        });
    }

    //新增任务
    function fn$new(el, clientid) {
        if (!clientid) {
            clientid = new Date().getTime();
            meeting.Jobs.push({ clientid: clientid, Relation: { JobUsers: [] }, StartTime: meeting.ShouldStartTime, EndTime: meeting.ShouldEndTime,TaskType:"日常任务",RiskLevel:"低风险" });
        }
        var html = '<tr class="grid-row" data-clientid="' + clientid + '">\
            <td class="col0"><div><textarea class="job maxwidth textbox" rows="2" name="Job" datatype="*1-200" nullmsg="不能为空" placeholder="请输入" type="text"></textarea><div class ="Validform_checktip"></div></div></td>\
            <td class="col1"><div><select name="TaskType" class="maxwidth textbox"><option value="日常工作">日常工作</option><option value="管理任务">管理任务</option><option value="巡回检查">巡回检查</option><option value="定期工作">定期工作</option><option value="消缺任务">消缺任务</option><option value="安全文明卫生检查">安全文明卫生检查</option><option value="其他工作">其他工作</option><select><div class="Validform_checktip"></div></div></td>\
            <td class="col2"><div><input class="selectPerson maxwidth textbox" name="JobUser" datatype="*" nullmsg="不能为空" placeholder="请点击选择" type="text" value="" onfocus="this.blur()" /><div class ="Validform_checktip"></div></div></td>\
            <td class="col3"><div><input type="text" class="datetime start" value="" onfocus="this.blur()" datatype="*" nullmsg="不能为空" placeholder="请选择" /><span class ="Validform_checktip"></span> - <input type="text" class="datetime end" value="" onfocus="this.blur()" datatype="*" nullmsg="不能为空" placeholder="请选择" /><span class ="Validform_checktip"></span></div></td>\
            <td class="col4"><div><div rows="2" class="selectDanger maxwidth textbox prettytext" name="ShowDangerousMeasure" title="" ></div><span class ="Validform_checktip"></span><input  name="Dangerous"  type="hidden" value=""><input  name="Measure"  type="hidden" value=""><span class ="Validform_checktip"></div></td>\
            <td class="col5"><div><select name="RiskLevel" class="maxwidth textbox"><option value="重大风险">重大风险</option><option value="较大风险">较大风险</option><option value="一般风险">一般风险</option><option value="低风险" selected="selected">低风险</option><select><div class="Validform_checktip"></div></div></td>\
            <td class="col6"><span class="my-checkbox training"></span></td>\
            <td class="col7"><a class="c-orange" onclick="fn$edit(this);" style="color:orange;cursor:pointer;">详情</a> <a class="c-orange" onclick="fn$delete(this);" style="color:orange;cursor:pointer;">删除</a></td>\
            </tr>';

        jQuery('#grid tbody').append(html);

        fn$InitDate(jQuery('#grid tr:last').get(0));

        if (el) {
            if (meeting.Jobs[meeting.Jobs.length - 1].StartTime && meeting.Jobs[meeting.Jobs.length - 1].EndTime) {
                jQuery('#grid .grid-row:last').find('.datetime:first').val(jQuery.format.date(meeting.Jobs[meeting.Jobs.length - 1].StartTime, 'yyyy/MM/dd HH:mm'));
                jQuery('#grid .grid-row:last').find('.datetime:last').val(jQuery.format.date(meeting.Jobs[meeting.Jobs.length - 1].EndTime, 'yyyy/MM/dd HH:mm'));
            }
        }

        $('.main-content').getNiceScroll().resize();
    }

    function fn$edit(el) {
        layer.open({
            area: ['1500px', '800px'],
            title: '工作任务详情',
            type: 2,
            content: '@Url.Action("JobDetail")'
        });
    }

    function fn$getjob() {
        return getJob();
    }

    function fn$seq() {
        jQuery('#grid tr').each(function (i) {
            jQuery(this).find('td.seq').text(i + 1);
        });
    }

    function fn$delete(e) {
        meeting.Jobs = jQuery.grep(meeting.Jobs, function (o) { return o.clientid != jQuery(e).parent().parent().data('clientid') });
        jQuery(e).parent().parent().remove();
    }

    function getJobDangers() {
        return getJob().DangerousList;
    }

    function loadJobs() {
        jQuery('#grid tbody').empty();

        jQuery.each(meeting.Jobs, function (i, o) {
            o.clientid = new Date().getTime();
            fn$new(null, o.clientid);
            jQuery('#grid .grid-row:last').find('.job').val(o.Job);
            var jobuser = '';
            jQuery.each(o.Relation.JobUsers || [], function (j, p) {
                jobuser += p.UserName + '、';
            });
            jobuser = jobuser.replace(/、$/, '');
            jQuery('#grid .grid-row:last').find('.selectPerson').val(jobuser);
            if (typeof (o.StartTime) == 'string') {
                if (o.StartTime.indexOf('Date') >= 0)
                    o.StartTime = new Date(parseInt(o.StartTime.replace(/^\/Date\(/, '').replace(/\)$/, '')));
                else
                    o.StartTime = new Date(o.StartTime.replace('T', ' '));
            }
            if (typeof (o.EndTime) == 'string') {
                if (o.EndTime.indexOf('Date') >= 0)
                    o.EndTime = new Date(parseInt(o.EndTime.replace(/^\/Date\(/, '').replace(/\)$/, '')));
                else
                    o.EndTime = new Date(o.EndTime.replace('T', ' '));
            }
            jQuery('#grid .grid-row:last').find('.datetime:first').val(jQuery.format.date(o.StartTime, 'yyyy/MM/dd HH:mm'));
            jQuery('#grid .grid-row:last').find('.datetime:last').val(jQuery.format.date(o.EndTime, 'yyyy/MM/dd HH:mm'));
            jQuery('#grid .grid-row:last').find('input[name=Dangerous]').val(o.Dangerous);
            jQuery('#grid .grid-row:last').find('input[name=Measure]').val(o.Measure);
            var stringStr = !!o.Dangerous ? ("危险因素：" + (!!o.Dangerous ? o.Dangerous : "") + "    防范措施：" + (!!o.Measure ? o.Measure : "")) : '';
            jQuery('#grid .grid-row:last').find('.selectDanger').text(stringStr).attr('title', stringStr);
            jQuery('#grid .grid-row:last').find('select[name=TaskType]').find("option[value=" + o.TaskType + "]").attr("selected", true);
            jQuery('#grid .grid-row:last').find('select[name=RiskLevel]').find("option[value=" + o.RiskLevel + "]").attr("selected", true);

            if (o.NeedTrain)
                jQuery('#grid .grid-row:last').find('.training').addClass('actives');
        });
    }

    function getJob() {
        var clientid = jQuery('#grid tr.selected').data('clientid');
        var items = jQuery.grep(meeting.Jobs, function (o, i) {
            return o.clientid == clientid;
        });
        if (items.length == 0) return null;
        return items[0];
    }

    function startMeeting() {
        isStart = true;
        validform.submitForm();
    }

    function saveMeeting() {
        validform.submitForm();
    }

</script>
@using (Html.BeginForm("Start", "WorkMeeting", FormMethod.Post, new { @class = "sf" }))
{
<div class="main-content">
    <div class="container-fluid">
        <div class="clearfix mg-b-10" style="overflow:hidden;">
            <div class="pull-left">
                <div class="my-tab">
                    <ul class="clearfix handler">
                        <li class="active">@Html.ActionLink("班前会", "Start")</li>
                        <li>@Html.ActionLink("班后会", "End")</li>
                    </ul>
                </div>
            </div>
            <div class="pull-right">
                <a href="@Url.Action("List", new { page="1" , pagesize="12" })">
                    <img src="@Url.Content("~/Content/styles/static/images/index_29.png")" style="margin-top:-2px;" alt="">
                    历史记录
                </a>
            </div>
        </div>
        <div class="bg-e3ebfd pd-10 warp my-body">
            <div class="aside pd-20 bd-e3ebfd" style="position:fixed;bottom:50px;right:60px;width:256px;">
                <input type="button" id="btn-submit" class="bg-3669e1" style="border:none;color:white;width:100%;font-size:18px;line-height:60px;width:210px;" value="开始会议" onclick="startMeeting();" />
                <input type="button" id="btn-save" class="bg-3669e1" style="border:none;color:white;width:100%;font-size:18px;line-height:60px;width:210px;margin-top:10px;" value="保存记录" onclick="saveMeeting();" />
            </div>
            <div class="body" style="background:#fff;height:100%;">
                <div class="table-head f-15 f-w bg-fff pd-10 pd-l-20 c-0d0d0d bd-b-e3ebfd">
                    工作任务部署
                </div>
                <div>
                    <table class="table table-striped" style="margin-bottom:0px;">
                        <thead>
                            <tr>
                                <th class="col0">工作任务</th>
                                <th class="col1">任务类别</th>
                                <th class="col2">作业人</th>
                                <th class="col3">计划时间</th>
                                <th class="col4">风险辨识评估</th>
                                <th class="col5">风险等级</th>
                                <th class="col6">是否KYT</th>
                                <th class="col7">操作</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
                <div>
                    <table class="table" id="grid">
                        <tbody>
                        </tbody>
                    </table>
                </div>
                <div class="text-center table bg-fff" style="border-top:1px solid #e3ebfd;padding:10px 0; margin-bottom:6px;">
                    <a class="add icon-btn" href="javascript:;" onclick="fn$new(this)" id="btn-new"></a>
                </div>
                <div class="pd-20 bg-fff bd-2t-e3ebfd">
                    <div class="f-15 f-w c-0d0d0d">其他事项</div>
                    <div class="table-div f-16 c-4a4e50 lh-36 pd-b-20" style="height:80px;">
                        @Html.TextAreaFor(x => x.Remark, new { style = "height:100%;width:100%;border:2px solid #e3ebfd;outline:none;color:#333;padding:0 10px;resize:none;", maxlength = 500 })
                    </div>
                </div>
                @*<div class="pd-20 bg-fff bd-2t-e3ebfd" style="padding-bottom:0;min-height:80px;">
                        <div class="clearfix audio">
                            <div class="pull-left f-18 f-w c-0d0d0d left">现场音频</div>
                            <div class="pull-left right">
                                <ul></ul>
                            </div>
                        </div>
                    </div>
                    <div class="pd-20 bg-fff bd-2t-e3ebfd photo" style="min-height:110px;">
                        <div class="mg-b-10">
                            <div class="f-18 f-w c-0d0d0d">现场照片</div>
                        </div>
                        <div class="clearfix">
                        </div>
                    </div>*@
            </div>

        </div>
        <footer class="main-footer">
            武汉博晟安全技术股份有限公司   版权所有
        </footer>
    </div>
</div>}

<!--选择作业人员弹出层-->
<div class="my-modal" id="jobuser-modal" style="height:100%;overflow-y:auto;padding:0px 30px;">
    <div>
        <table class="table" style="text-align:center;">
            <tr>
                <td style="width:40%;">班组成员</td>
                <td style="width:30%;">工作负责人</td>
                <td style="width:30%;">工作班成员</td>
            </tr>
        </table>
    </div>
</div>
<script>
    jQuery(function () {
        //人员选择初始化
        fn$InitPerson();

        //选择行
        jQuery('#grid').on('mousedown', '.grid-row', function () {
            jQuery(this).siblings().removeClass('selected');
            jQuery(this).addClass('selected');
        });

        //点击作业人
        jQuery('#grid').on('click', '.selectPerson', function () {
            jQuery('#jobuser-modal tr span.on').removeClass('on');

            var job = getJob();
            jQuery.each(job.Relation.JobUsers, function () {
                jQuery('#jobuser-modal tr[data-id="' + this.UserId + '"] span.' + this.JobType).addClass('on');
            });

            layer.open({
                area: ['600px', jQuery(window).height() - 200 + 'px'],
                title: '选择作业人',
                type: 1,
                btn: ['确定', '取消'],
                content: $('#jobuser-modal'),
                yes: function (index) {
                    var ary = [];
                    jQuery('#jobuser-modal td:has(span.on[data-role="ischecker"])').each(function () {
                        ary.push({ UserId: jQuery(this).parent().data('id'), UserName: jQuery(this).parent().find('td').first().text(), JobType: 'ischecker' });
                    });

                    if (ary.length == 0) {
                        layer.msg('请选择工作负责人');
                        return false;
                    }

                    jQuery('#jobuser-modal td:has(span.on[data-role="isdoperson"])').each(function () {
                        ary.push({ UserId: jQuery(this).parent().data('id'), UserName: jQuery(this).parent().find('td').first().text(), JobType: 'isdoperson' });
                    });
                    var text = '';
                    jQuery.each(ary, function () {
                        text += this.UserName + '、'
                    });
                    text = text.replace(/、$/, '');
                    jQuery('tr.selected .selectPerson').val(text);
                    var job = getJob();
                    job.Relation.JobUsers = ary;

                    $('#jobuser-modal').hide();
                    layer.close(index);
                },
                cancel: function () {
                    $('#jobuser-modal').hide();
                },
            });
        });

        //选择作业人
        jQuery('#jobuser-modal .table').on('click', 'td span.my-ck', function () {
            if (jQuery(this).hasClass('on')) {
                jQuery(this).removeClass('on');
            } else {
                if (jQuery(this).hasClass('ischecker')) {
                    jQuery(this).parent().parent().find('.isdoperson').removeClass('on');
                    jQuery('#jobuser-modal .table .ischecker').removeClass('on')
                } else {
                    jQuery(this).parent().parent().find('.ischecker').removeClass('on');
                }
                jQuery(this).addClass('on');
            }
        });
    });

    //班组人员初始化
    function fn$InitPerson() {
        jQuery.getJSON('@Url.Action("GetPersons")', function (data) {
            if (jQuery.isEmptyObject(data)) return;

            jQuery.each(data, function () {
                jQuery('#jobuser-modal .table').append('<tr data-id="' + this.ID + '"><td>' + this.Name + '</td><td><span class="my-ck ischecker" data-role="ischecker"></span></td><td><span class="my-ck isdoperson" data-role="isdoperson"></span></td></tr>');
            });
        });
    }

</script>

<!--选择危险因素-->
<div id="list-dangerous" class="sign modal" style="position:relative;padding:0px;height:100%;">
    <div style="height:100%;">
        <ul class="nav measure_nav ul-container" style="overflow-y:auto;padding:0px 30px;min-height:0px;max-height:initial;"></ul>
        <div style="padding:0px 30px; height:200px;">
            <button class="add_btn" style="width:100%;background-color:#3668e1;line-height:50px;border:none;"><img src="@Url.Content("~/Content/styles/static/images/measure_add.png")"></button>
            <input type="text" placeholder="请输入" maxlength="100" style="width:100%; height:50px;">
        </div>
    </div>
</div>
<script>
    function openDangerous() {
        var job = getJob();
        dangerousList = job.DangerousList || [];
        jQuery('#list-dangerous li.select').removeClass('select');

        jQuery.each(dangerousList, function (i, o) {
            jQuery('#list-dangerous li[data-id="' + o.DangerousId + '"]').addClass('select');
        });

        jQuery('#list-dangerous').show();
        layer.open({
            title: '危险因素',
            type: 1,
            area: ['400px', jQuery(window).height() - 200 + 'px'],
            content: jQuery('#list-dangerous'),
            scrollbar: true,
            btn: ['确定', '取消'],
            yes: function (index) {
                ensureDangerous();
                jQuery('#list-dangerous').hide();
                layer.close(index);
            },
            end: function () {
                jQuery('#list-dangerous').hide();
            }
        });
    }

    jQuery(function () {
        jQuery('#list-dangerous div ul').height(jQuery(window).height() - 400);

        //点击危险因素
        jQuery('#grid').on('click', '.selectDanger', function () {
            jQuery(this).blur();

            layer.open({
                id:'DangerReview',
                type: 2,
                title: '风险辨识评估',
                shade: 0.6,
                area: ['1280px', '720px'],
                content: '@Url.Action("DangerReview")',
                btn: ['确定'],
                yes: function (idx, layero) {
                    var iframeWin = window[layero.find('iframe')[0]['name']];
                    var dangerList = iframeWin.fn$ok();
                    var job = getJob();
                    job.DangerousList = dangerList;
                    ensureDangerous();
                    layer.close(idx);
                }
            });
            //openDangerous();
        });

        //删除按钮阻止事件冒泡
        jQuery('#list-dangerous').on('mousedown', '.delete_btn', function (e) {
            e.stopPropagation();
        });

        //删除危险因素
        jQuery('#list-dangerous').on('click', '.delete_btn', function () {
            var el = this;
            jQuery.post('@Url.Action("DeleteDangerous")', { id: jQuery(this).parent().data('id') }, function (data) {
                if (data.success) {
                    jQuery(el).parent().remove();
                } else {
                    layer.msg(data.message);
                }
            }, 'json');
        });

        //点击隐藏删除
        jQuery(document).mousedown(function () {
            jQuery('#list-dangerous li.remove').toggleClass('remove');
            jQuery('#list-measures li.remove').toggleClass('remove');
        });

        //新增危险因素
        jQuery('#list-dangerous').on('click', '.add_btn', function () {
            var input = jQuery(this).next();
            var text = input.val();
            if (!text) return;

            jQuery.post('@Url.Action("PostDangerous")', { Content: text }, function (data) {
                if (data.success) {
                    jQuery('#list-dangerous ul').prepend('<li data-id="' + data.data.ID + '"><span>' + data.data.Content + '</span><button class="delete_btn">删除</button></li>');
                    input.val('');

                    jQuery('#list-dangerous ul li span').each(function () {
                        var el = jQuery(this).parent().get(0);
                        var hammer = new Hammer(this);
                        hammer.on('press', function (e) {
                            jQuery(el).addClass('remove');
                        });
                        hammer.on('tap', function (e) {
                            if (jQuery(el).hasClass('select'))
                                removeDangerous(jQuery(el).data('id'));
                            else
                                fn$loadMeasures({ DangerousId: jQuery(el).data('id'), Content: jQuery(el).find('span').text().trim() });
                            jQuery(el).toggleClass('select');
                        });
                    });
                } else {
                    layer.msg(data.message, { icon: 2 });
                }
            }, 'json');
        });

        //载入危险因素
        jQuery.getJSON('@Url.Action("GetDangerous")', {}, function (data) {
            if (data) {
                jQuery.each(data, function (i, o) {
                    jQuery('#list-dangerous ul').append('<li data-id="' + o.ID + '"><span>' + o.Content + '</span><button class="delete_btn">删除</button></li>')
                });
                jQuery('#list-dangerous ul li span').each(function () {
                    var el = jQuery(this).parent().get(0);
                    var hammer = new Hammer(this);
                    hammer.on('press', function (e) {
                        jQuery(el).addClass('remove');
                    });
                    hammer.on('tap', function (e) {
                        if (jQuery(el).hasClass('select')) {
                            removeDangerous(jQuery(el).data('id'));
                            jQuery(el).removeClass('select');
                        } else {
                            fn$loadMeasures({ DangerousId: jQuery(el).data('id'), Content: jQuery(el).find('span').text().trim() });
                            jQuery(el).addClass('select');
                        }
                    });
                });
            }
        });
    });

    var dangerousList = [];
    function removeDangerous(dangerid) {
        jQuery('#list-dangerous li.select[data-id="' + dangerid + '"]').removeClass('select');
        dangerousList = jQuery.grep(dangerousList, function (o) { return o.DangerousId != dangerid; });
    }

    function ensureDangerous() {
        var job = getJob();
        //job.DangerousList = dangerousList;
        var dangerous = '', measure = '';
        jQuery.each(job.DangerousList, function (i, o) {
            dangerous += o.Content + '。';
            jQuery.each(o.MeasureList, function (j, p) {
                measure += p.Content + '。';
            });
        });
        job.Dangerous = !!dangerous ? dangerous : "";
        job.Measure = !!measure ? measure : "";
        jQuery('#grid .selected').find('input[name=Dangerous]').val(dangerous);
        jQuery('#grid .selected').find('input[name=Measure]').val(measure);
        var stringStr = !!job.Dangerous ? ("危险因素：" + dangerous + "    防范措施：" + measure) : '';
        jQuery('#grid .selected').find('.selectDanger').text(stringStr).attr('title', stringStr);;
        //jQuery('#grid .selected').find('.selectMeasure').val(measure);
    }
</script>

@*<div class="modal fade sign" id="modal_dangerous" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-sm" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                    <h4 class="modal-title">选择危险因素</h4>
                </div>
                <div class="modal-body" style="padding-top: 0;">
                    <div class="measure_box" id="dangerous_box">
                        <div class="ul-container">
                            @{
                                var dangerous = ViewBag.dangerous as IEnumerable<JobTemplateEntity>;
                            }
                            <ul class="nav measure_nav" id="dangerous_nav">
                                @foreach (var item in dangerous)
                                {
                                    <li data-id="@Html.Raw(item.JobId)">
                                        <span>@Html.Raw(item.Dangerous)</span>
                                        <button class="delete_btn">删除</button>
                                    </li>
                                }
                            </ul>
                        </div>
                        <button class="add_btn"><img src="@Url.Content("~/Content/styles/static/images/measure_add.png")"></button>
                        <div class="measure_text" id="dangerous_text">
                            <input type="text" placeholder="请输入" maxlength="100" style="width:100%; height:50px;" />
                        </div>
                    </div>
                    <div class="text-center mg-t-10">
                        <button class="btn bg-3669e1 c-fff measure_ok" style="width:200px;" data-dismiss="modal">确定</button>
                    </div>
                </div>
            </div>
        </div>
    </div>*@

<!--选择防范措施弹出窗-->
<div id="list-measures" class="sign modal" style="position:relative;padding:0px;height:100%;">
    <div style="height:100%;">
        <ul class="nav measure_nav ul-container" style="overflow-y:auto;padding:0px 30px;min-height:0px;max-height:initial;"></ul>
        <div style="padding:0px 30px; height:200px;">
            <button class="add_btn" style="width:100%;background-color:#3668e1;line-height:50px;border:none;"><img src="@Url.Content("~/Content/styles/static/images/measure_add.png")"></button>
            <input type="text" placeholder="请输入" maxlength="100" style="width:100%; height:50px;">
        </div>
    </div>
</div>
<script>
    jQuery(function () {
        //点击防范措施
        jQuery('#grid').on('click', '.selectMeasure', function () {
            jQuery(this).blur();
            openDangerous();
        });

        //删除按钮阻止事件冒泡
        jQuery('#list-measures').on('mousedown', '.delete_btn', function (e) {
            e.stopPropagation();
        });

        //删除防范措施
        jQuery('#list-measures').on('click', '.delete_btn', function () {
            var el = this;
            jQuery.post('@Url.Action("DeleteMeasure")', { id: jQuery(this).parent().data('id') }, function (data) {
                if (data.success) {
                    jQuery(el).parent().remove();
                } else {
                    layer.msg(data.message);
                }
            }, 'json');
        });

        //新增防范措施
        jQuery('#list-measures').on('click', '.add_btn', function () {
            var dangerid = jQuery('#list-measures ul').data('id');
            var input = jQuery(this).next();
            var text = input.val();
            if (!text) return;

            jQuery.post('@Url.Action("PostMesuare")', { Content: text, RiskFactorId: dangerid }, function (data) {
                if (data.success) {
                    jQuery('#list-measures ul').prepend('<li data-id="' + data.data.ID + '"><span>' + data.data.Content + '</span><button class="delete_btn">删除</button></li>');
                    input.val('');
                    jQuery('#list-measures ul li').first().each(function () {
                        var el = this;
                        var hammer = new Hammer(this);
                        hammer.on('press', function (e) {
                            jQuery(el).addClass('remove');
                        });
                        hammer.on('tap', function (e) {
                            jQuery(el).toggleClass('select');
                        });
                    });
                } else {
                    layer.msg(data.message, { icon: 2 });
                }
            }, 'json');
        });
    });

    //防范措施确定
    function ensureMeasure(id, ary) {
        if (ary.length == 0) {
            jQuery('#list-dangerous li[data-id="' + id + '"]').removeClass('select');
            removeDangerous(id);
        }
        else {
            var dangerous = jQuery.grep(dangerousList, function (o, i) {
                return o.DangerousId == id;
            })[0];
            dangerous.MeasureList = ary;
        }
    }

    //加载防范措施
    function fn$loadMeasures(dangerous) {
        dangerousList.push(dangerous);
        jQuery('#list-measures ul').empty();
        jQuery('#list-measures div ul').height(jQuery(window).height() - 400);
        jQuery('#list-measures div ul').data('id', dangerous.DangerousId);
        jQuery.getJSON('@Url.Action("GetMeasures")', { dangerid: dangerous.DangerousId }, function (data) {
            if (data) {
                jQuery.each(data, function (i, o) {
                    jQuery('#list-measures ul').append('<li data-id="' + o.ID + '"><span>' + o.Content + '</span><button class="delete_btn">删除</button></li>')
                });
            }
            jQuery('#list-measures ul li').each(function () {
                var el = this;
                var hammer = new Hammer(this);
                hammer.on('press', function (e) {
                    jQuery(el).addClass('remove');
                });
                hammer.on('tap', function (e) {
                    jQuery(el).toggleClass('select');
                });
            });
        });

        layer.open({
            title: '防范措施',
            type: 1,
            area: ['500px', jQuery(window).height() - 200 + 'px'],
            content: jQuery('#list-measures'),
            scrollbar: true,
            btn: ['确定', '取消'],
            yes: function (index, layero) {
                var ary = [];
                jQuery('#list-measures li.select').each(function () {
                    ary.push({ DangerousId: jQuery(this).data('id'), Content: jQuery(this).find('span').text().trim() });
                });
                ensureMeasure(jQuery('#list-measures ul').data('id'), ary);
                jQuery('#list-measures').hide();
                layer.close(index);
            },
            btn2: function () {
                removeDangerous(jQuery('#list-measures ul').data('id'));
                jQuery('#list-measures').hide();
            },
            cancel: function () {
                removeDangerous(jQuery('#list-measures ul').data('id'));
                jQuery('#list-measures').hide();
            }
        });

        jQuery('#list-measures').show();
    }
</script>
@*<div class="modal fade sign" id="modal_measure" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-sm" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                    <h4 class="modal-title">选择防范措施</h4>
                </div>
                <div class="modal-body" style="padding-top: 0;">
                    <div class="measure_box" id="measure_box">
                        <div class="ul-container">
                            @{
                                var measure = ViewBag.measure as IEnumerable<JobTemplateEntity>;
                            }
                            <ul class="nav measure_nav" id="measure_nav">
                                @foreach (var item in measure)
                                {
                                <li data-id="@Html.Raw(item.JobId)">
                                    <span>@Html.Raw(item.Measure)</span>
                                    <button class="delete_btn">删除</button>
                                </li>
                                }
                            </ul>
                        </div>
                        <button class="add_btn"><img src="@Url.Content("~/Content/styles/static/images/measure_add.png")"></button>
                        <div class="measure_text" id="measure_text">
                            <input type="text" placeholder="请输入" maxlength="100" style="width:100%; height:50px;" />
                        </div>
                    </div>
                    <div class="text-center mg-t-10">
                        <button class="btn bg-3669e1 c-fff measure_ok" style="width:200px;" data-dismiss="modal">确定</button>
                    </div>
                </div>
            </div>
        </div>
    </div>*@
